<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ä¸­åœ°å€ç©ºæ±¡æ¿ƒåº¦å±•ç¤º</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet-groupedlayercontrol/0.6.1/leaflet.groupedlayercontrol.min.css" />

    <style>

        /*-----------------------------------------------------------------------*/
        /* 2. è¨­å®šåœ°åœ–å®¹å™¨çš„å¤§å° */
        #map {
            height: 85vh;
            width: 95%;
            margin: 0 auto; /* ğŸŒŸ åŠ ä¸Šé€™ä¸€è¡Œï¼Œåœ°åœ–å°±æœƒåœ¨ç¶²é ä¸­é–“ */
            border-radius: 8px;
            border-width: 0.5cm;
            border-color: #333;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f4f7f6;
        }
        h1 {
            font-size:large;
            margin-left: 25px;
            padding: 20px;
            color: #2c3e50;
        }

        /*-----------------------------------------------------------------------*/
        /* åœ–ä¾‹çš„å®¹å™¨æ¨£å¼ */
        .legend {
            line-height: 18px;
            color: #555;
            background: white;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
        }
        /* åœ–ä¾‹ä¸­çš„é¡è‰²æ–¹å¡Š */
        .legend i {
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 8px;
            opacity: 0.7;
        }

        .legend h4 {
            margin: 0 0 5px;
            font-size: 14px;
        }
    
    /*-----------------------------------------------------------------------------*/
    /* åæ¨™é¡¯ç¤ºæ¡† */
    /* 1. å¼·åˆ¶è®“ Leaflet å·¦ä¸‹è§’å®¹å™¨æ©«è·¨ 100% å¯¬åº¦ï¼Œä»¥ä¾¿ç½®ä¸­ */
        .leaflet-bottom.leaflet-left {
            width: 100%;
            display: flex;
            justify-content: center;
            pointer-events: none; /* è®“å®¹å™¨ä¸æ“‹ä½åœ°åœ– */
            margin-bottom: 15px;
        }

        /* 2. åº§æ¨™é¡¯ç¤ºæ¡†æœ¬é«” */
        .coordinate-display {
            pointer-events: auto;  /* æ¢å¾©æ¡†æ¡†æœ¬èº«çš„æ„Ÿæ‡‰ */
            padding: 8px 20px;
            background: rgba(44, 62, 80, 0.9); /* ç§‘æŠ€æ·±è— */
            color: #ffffff;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 30px;
            
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            font-weight: 500;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            white-space: nowrap;
            z-index: 1000;
        }

        /* ç¢ºä¿æ¯”ä¾‹å°ºè·Ÿç¸®æ”¾æŒ‰éˆ•ä¸è¦è¢«æ“ åˆ°ä¸­é–“ (ç¶­æŒåœ¨å·¦é‚Š) */
        .leaflet-left .leaflet-control-scale, 
        .leaflet-left .leaflet-control-zoom {
            margin-left: 10px;
            position: absolute;
            bottom: 0;
            left: 0;
        }

        /*-----------------------------------------------------------------------*/
        /* é‡å°å·¦ä¸‹è§’çš„ç¸®æ”¾æ§åˆ¶é …é€²è¡Œä½ç§» */
        .leaflet-bottom.leaflet-left .leaflet-control-zoom {
            position: absolute;   /* è„«é›¢ flex ä½ˆå±€çš„ç½®ä¸­å½±éŸ¿ */
            left: 10px;          /* é å·¦å›ºå®š */
            bottom: 40px;       /* ğŸŒŸ å‘ä¸Šæ¨é«˜ï¼Œé¿é–‹æ¯”ä¾‹å°ºèˆ‡åº§æ¨™æ¡† */
            margin: 0;
        }

        /* é‡å°æ¯”ä¾‹å°ºé€²è¡Œä½ç§»ï¼Œé¿å…è·Ÿåº§æ¨™æ¡†ç–Šåœ¨ä¸€èµ· */
        .leaflet-bottom.leaflet-left .leaflet-control-scale {
            position: absolute;
            left: 10px;
            bottom: 5px;        /* é‡˜åœ¨æœ€åº•éƒ¨ */
            margin: 0;
        }

        /*--------------------------------å°ä¸­é„‰é®åœ–å±¤---------------------------------------*/
        /* ç§»é™¤ Tooltip çš„é è¨­æ¨£å¼ï¼Œåªä¿ç•™æ–‡å­— */
        .leaflet-tooltip.district-label {
            background-color: transparent;
            border: none;
            box-shadow: none;
            font-size: 14px;
            font-weight: bold;
            color: #333;
            text-shadow: 1px 1px 2px white; /* æ–‡å­—å¤–æ¡†ç™½é‚Šï¼Œå¢åŠ æ˜“è®€æ€§ */
            pointer-events: none; /* é¿å…æ–‡å­—é˜»æ“‹æ»‘é¼ é»æ“Šä¸‹æ–¹çš„åœ°åœ– */
        }
        /* éš±è— Tooltip çš„ç®­é ­ */
        .leaflet-tooltip-left:before, .leaflet-tooltip-right:before {
            display: none;
        }


        /*--------------------------------å³ä¸Šè§’çš„é¸å–®--------------------------------------*/
        /* --- 1. åŸºæœ¬å®¹å™¨ç¾åŒ– --- */
        .leaflet-control-layers-expanded {
            padding: 10px !important;
            min-width: 180px;
            background: #fff;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            border-radius: 8px;
        }

        /* --- 2. ç¾¤çµ„æ¨™é¡Œç¾åŒ– (Dropdown Header) --- */
        .leaflet-control-layers-group-name {
            display: flex !important;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            font-weight: bold;
            padding: 8px 5px;
            margin-top: 5px;
            background: #f8f9fa;
            border-radius: 4px;
            border-left: 4px solid #e2e9be; /* å·¦å´è—æ¢å¢åŠ è­˜åˆ¥åº¦ */
            transition: background 0.3s;
        }

        .leaflet-control-layers-group-name:hover {
            background: #e9ecef;
        }

        /* åœ¨æ¨™é¡Œå¾Œæ–¹åŠ å…¥å°ç®­é ­ (é¸é…) */
        .leaflet-control-layers-group-name::after {
        /*  content: 'â–¼';*/
            font-size: 10px;
            color: #999;
        }

        /* --- 3. å­é¸é …å®¹å™¨æ§åˆ¶ --- */
        /* é è¨­éš±è—å­é¸é … */
        .leaflet-control-layers-group-selector {
            display: none; 
            padding: 5px 10px;
            border: 1px solid #eee;
            border-top: none;
            background: #ffffff;
            margin-bottom: 5px;
        }

        /* --- 2. ç•¶å¤–å±¤æœ‰ .is-open æ™‚é¡¯ç¤º (å¼·åˆ¶é¡¯ç¤º) --- */
        .leaflet-control-layers-group.is-open .leaflet-control-layers-group-selector {
            display: block !important;
        }

        /* é¡¯ç¤ºå­é¸é …çš„ Class (é€é JS åˆ‡æ›) */
        .leaflet-control-layers-group.is-open .leaflet-control-layers-group-selector {
            display: block;
        }

        /* å±•é–‹æ™‚æ—‹è½‰ç®­é ­ 
        .leaflet-control-layers-group.is-open .leaflet-control-layers-group-name::after {
            content: 'â–²';
        }*/

    </style>
</head>

<style>
    /* Reset & å…¨å±€å­—é«” */
    body {
        margin: 0;
        padding: 0;
        font-family: "Microsoft JhengHei", Arial, sans-serif;
    }

    /* --- 1. é ‚éƒ¨å°èˆªæ¬„æ¨£å¼ --- */
    .site-header {
        background-color: #4b5066; /* å¸ç®¡å–è‰²ï¼šæ·±è—ç°è‰² */
        color: #fff;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 40px; /* ä¸Šä¸‹15pxï¼Œå·¦å³40px */
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    /* å·¦å´ Logo å€åŸŸ */
    .header-left {
        display: flex;
        align-items: center;
        gap: 15px; /* Logo èˆ‡æ–‡å­—çš„é–“è· */
    }

    /* æ¨¡æ“¬é‚£å€‹ç´…è‰²çš„åœ“å½¢ Logo (è«‹æ›æˆçœŸæ­£çš„åœ–ç‰‡) */
    .logo-img {
        width: 50px;
        height: 50px;
        background-color: #ffffff; /* ç´…è‰²èƒŒæ™¯ */
        border-radius: 50%; /* è®Šåœ“å½¢ */
        display: flex;
        justify-content: center;
        align-items: center;
        font-weight: bold;
        font-size: 12px;
        color: white;
        flex-shrink: 0; /* é˜²æ­¢ç¸®å° */
    }
    
    /* å¦‚æœä½ æœ‰çœŸæ­£çš„åœ–ç‰‡ï¼Œè«‹ç”¨é€™å€‹ class */
    /* .logo-img { width: 50px; height: auto; } */

    /* æ¨™é¡Œæ–‡å­—å€å¡Š */
    .site-title-group {
        display: flex;
        flex-direction: column; /* å‚ç›´æ’åˆ— */
        justify-content: center;
        line-height: 1.4;
    }

    .main-title {
        font-size: 25px;
        font-weight:bold;
        letter-spacing: 0.5px;
    }

    .sub-title {
        font-size: 14px;
        color: #d1d5db; /* ç¨å¾®æ·¡ä¸€é»çš„ç™½è‰² */
    }

    /* å³å´å°èˆªé€£çµ */
    .header-right ul {
        list-style: none;
        margin: 0;
        padding: 0;
        display: flex;
        gap: 40px; /* é¸å–®ä¹‹é–“çš„è·é›¢ */
    }

    .header-right a {
        text-decoration: none;
        color: #fff;
        font-size: 20px;
        font-weight: 700;
        transition: opacity 0.3s;
    }

    .header-right a:hover {
        opacity: 0.8; /* æ»‘é¼ ç§»éå»è®Šç¨å¾®é€æ˜ */
        text-decoration: underline;
    }

    /* --- 2. Banner (å¤§æ¨™é¡Œå€å¡Š) --- */
    .hero-banner {
        /* é€™è£¡ç”¨äº†å…©å±¤èƒŒæ™¯ï¼šä¸Šå±¤æ˜¯åŠé€æ˜ç™½è‰²é®ç½©ï¼Œä¸‹å±¤æ˜¯åœ°åœ–åœ–ç‰‡ */
        background: 
            linear-gradient(rgba(255, 255, 255, 0.6), rgba(255, 255, 255, 0.1)),
            url('background1.png'); /* é€™è£¡æ›æˆä½ æƒ³è¦çš„åº•åœ– */
        
        background-size: cover;
        background-position: center;
        height: 250px; /* é«˜åº¦å¯è‡ªè¡Œèª¿æ•´ */
        display: flex;
        flex-direction: column;
        justify-content: center; /* å‚ç›´ç½®ä¸­ */
        padding-left: 80px; /* æ–‡å­—é›¢å·¦é‚Šçš„è·é›¢ï¼Œå°é½Šä¸Šé¢çš„ Logo */
        border-bottom: 1px solid #ddd;
    }

    .hero-banner h1 {
        margin: 0;
        font-size: 45px; /* ä¸»æ¨™é¡Œå¤§å° */
        color: #000;
        letter-spacing: 1px;
    }

    .hero-banner p {
        margin: 10px 0 0 20px; /* ä¸Šé–“è·10pxï¼Œå·¦ç¸®æ’20px */
        font-size: 30px;
        color: #333;
        font-weight: 800;
    }

    /* æ‰‹æ©Ÿç‰ˆç°¡å–®é©é… */
    @media (max-width: 768px) {
        .site-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 15px;
            padding: 15px 20px;
        }
        .header-right ul {
            width: 100%;
            justify-content: space-between;
            gap: 10px;
        }
        .hero-banner {
            height: 180px;
            padding-left: 20px;
        }
        .hero-banner h1 { font-size: 28px; }
        .hero-banner p { font-size: 18px; }

       
    }

    /* ==========================================================================
        ğŸ‘‡ğŸ‘‡ğŸ‘‡ é å°¾ (Footer) æ¨£å¼å€ ğŸ‘‡ğŸ‘‡ğŸ‘‡
    ========================================================================== */
    .site-footer {
        background-color: #928a97; /* å¸å–åœ–ç‰‡ä¸­çš„ç°ç´«è‰² */
        color: #ffffff;            /* ç™½è‰²æ–‡å­— */
        text-align: center;        /* æ–‡å­—ç½®ä¸­ */
        padding: 40px 0;           /* ä¸Šä¸‹ç•™ç™½ï¼Œè®“å®ƒçœ‹èµ·ä¾†å¯¬ä¸€é» */
        margin-top: 30px;          /* èˆ‡ä¸Šæ–¹åœ°åœ–æ‹‰é–‹ä¸€é»è·é›¢ */
        font-family: "Microsoft JhengHei", Arial, sans-serif;
    }

    .footer-info {
        font-size: 18px;
        font-weight: 800;           /* å‰å…©è¡Œçš„å­—å¤§ä¸€é» */
        margin-bottom: 15px;       /* è¡Œèˆ‡è¡Œä¹‹é–“çš„é–“è· */
        letter-spacing: 1px;       /* å­—è·ç¨å¾®æ‹‰é–‹ï¼Œæ¯”è¼ƒæœ‰è³ªæ„Ÿ */
        line-height: 2;          /* è¡Œé«˜ */
    }

    .copyright {
        font-size: 12px;           /* ç‰ˆæ¬Šå®£å‘Šå­—å°ä¸€é» */
        font-weight: bold;
        margin-top: 25px;          /* èˆ‡ä¸Šæ–¹è³‡è¨Šæ‹‰é–‹è·é›¢ */
        opacity: 0.9;              /* ç¨å¾®é€æ˜ä¸€é»é» */
    }
</style>

<header>
    <div class="site-header">
        <div class="header-left">
            <img src="logo.png" class="logo-img">

            <div class="site-title-group">
                <span class="main-title">Geo-AI æ–¼ä¸­éƒ¨ç©ºå“å€ PM2.5 èˆ‡ NO2 æ™‚ç©ºæ¨ä¼°åŠä¸­ç«æ±¡æŸ“å½±éŸ¿åˆ†æä¹‹æ‡‰ç”¨</span>
            </div>
        </div>

        <nav class="header-right">
            <ul>
                <li><a href="index.html">æ¨ä¼°åœ–å±•ç¤º</a></li>
            </ul>
        </nav>
    </div>

    <div class="hero-banner">
        <h1>PM2.5 èˆ‡ NO2 æ¨ä¼°æ¿ƒåº¦å±•ç¤º</h1>
        <p>- ä»¥å°ä¸­åœ°å€ç‚ºä¾‹</p>
    </div>
</header>

<body>

    <h1>*æ¨ä¼°åœ–æ™‚é–“è§£æåº¦ï¼šæ—¥å¹³å‡<br><br>*ç’°å¢ƒéƒ¨ PM2.5 æ¿ƒåº¦ä¹‹ç›¸é—œæ¨™æº–ï¼šæ—¥å¹³å‡å°æ–¼ 30 Âµg/mÂ³</h1>

    <div id="map"></div>

    <footer class="site-footer">
        <div class="footer-info">
            <div>Name ï¼š Lai Sin Yi</div>
            <div>Location ï¼š Taichung,Nantun</div>
        </div>
        <div class="copyright">
            &copy; produced by sunicute
        </div>
    </footer>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-groupedlayercontrol/0.6.1/leaflet.groupedlayercontrol.min.js"></script>
    <script src="pollution_points.js"></script>
    <script src="pollution_points_no2.js"></script>
    <script src="taiwan_bounds.js"></script>  
    <script src="station_data.js"></script>
    <script src="taichung_bounds.js"></script>
    <script src="taichung_road.js"></script>          


    <script>

    /*----------------------------------------------------------------------åŠ å…¥åœ°åœ–åº•åœ–----------------------------------------------------------------------------------*/
    // 1.1 åŠ å…¥åº•åœ– (OSM)
    var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    });
    // 1.2 å®šç¾©è¡›æ˜Ÿåº•åœ– (Esri World Imagery)
    var satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EBP, and the GIS User Community'
    });

    // 2. åˆå§‹åŒ–åœ°åœ–ï¼Œé è¨­ä½¿ç”¨ osm åœ–å±¤
    var map = L.map('map', {
        center: [24.21, 120.92],
        zoom: 10.5,
        layers: [osm] 
    });


    /*----------------------------------------------------------åŠ å…¥ç©ºæ±¡å½±åƒã€ç©ºæ±¡jsã€æ¸¬ç«™jsã€ç¸£å¸‚ç•Œåœ–å±¤ã€é“è·¯js--------------------------------------------------------------*/

    // 3. å®šç¾©å½±åƒé‚Šç•Œ (è«‹å°‡ä½ çš„ EPSG:3826 åº§æ¨™è½‰æ›ç‚º WGS84 ç·¯ç¶“åº¦)
    var imageBounds = [
        [23.755, 120.275], 
        [24.71, 121.6215]
    ];

    /*----------------------------- ç¸£å¸‚ç•Œåœ–å±¤ ----------------------------------*/
    var boundaryLayer = L.geoJSON(taiwanBounds, {
        style: {
            color: "#666666",    // ç·šæ¢é¡è‰²ï¼šæ·±ç°è‰²
            weight: 2,         // ç·šæ¢ç²—ç´°
            fillOpacity: 0,      // é€æ˜å¡«å……ï¼ˆåªç•™é‚Šæ¡†ï¼‰
            dashArray: '3',      // è™›ç·šæ•ˆæœ
            interactive: false   // è®“æ»‘é¼ ç©¿é€
        }
    }).addTo(map); 


    /*-----------------------------------PM25-------------------------------------*/
    // ç–ŠåŠ ä½ çš„ç©ºæ±¡å½±åƒ
    var pollutionOverlay = L.imageOverlay('pollution_map_mean.png', imageBounds, {
        opacity: 0.7,
        interactive: false 
    });
    // è‡ªå‹•ç¸®æ”¾åˆ°å½±åƒæ‰€åœ¨ä½ç½®
    //map.fitBounds(imageBounds);

    // 9.è®€å–PM25ç©ºæ±¡é»ä½æ•¸å€¼js
    var geojsonLayer = L.geoJSON(pollutionData, {
        pointToLayer: function (feature, latlng) {
            return L.circleMarker(latlng, {
                radius: 0.1,           
                fillColor: "#ff4500",
                color: "#000",
                weight: 0,          
                fillOpacity: 0.01,    
                opacity: 0.01,           
                interactive: true     
            });
        },
        onEachFeature: function (feature, layer) {
            var val = feature.properties.value;
            var displayValue = (val !== undefined) ? val.toFixed(2) : "N/A";

            layer.bindTooltip("PM2.5 æ¿ƒåº¦ : " + displayValue + " (Âµg/mÂ³)", {
                sticky: true,        
                direction: "top",
                offset: [0, -5]
            });

            layer.on({
                mouseover: function (e) {
                    var l = e.target;
                    l.setStyle({ radius: 8, fillOpacity: 1, weight: 2 });
                    l.bringToFront();    
                },
                mouseout: function (e) {
                    var l = e.target;
                    l.setStyle({ radius: 3, fillOpacity: 0.1, weight: 0 });
                }
            });
        }
    });

    /*-----------------------------------NO2-------------------------------------*/
    var pollutionOverlay2 = L.imageOverlay('pollution_map_mean_no2.png', imageBounds, {
        opacity: 0.7,
        interactive: false 
    });

    var geojsonLayer2 = L.geoJSON(pollutionNO2Data, {
        pointToLayer: function (feature, latlng) {
            return L.circleMarker(latlng, {
                radius: 0.1,           
                fillColor: "#134074",
                color: "#000",
                weight: 0,           
                fillOpacity: 0.01,     
                opacity: 0.01,           
                interactive: true     
            });
        },
        onEachFeature: function (feature, layer) {
            var val = feature.properties.value;
            var displayValue = (val !== undefined) ? val.toFixed(2) : "N/A";

            layer.bindTooltip("NO2 æ¿ƒåº¦ : " + displayValue + " (ppb)", {
                sticky: true,        
                direction: "top",
                offset: [0, -5]
            });

            layer.on({
                mouseover: function (e) {
                    var l = e.target;
                    l.setStyle({ radius: 8, fillOpacity: 1, weight: 2 });
                    l.bringToFront();    
                },
                mouseout: function (e) {
                    var l = e.target;
                    l.setStyle({ radius: 3, fillOpacity: 0.1, weight: 0 });
                }
            });
        }
    });

    /*------------------------------------------------------------------------------------------
      Group å®šç¾©èˆ‡é è¨­é–‹å•Ÿ
    -------------------------------------------------------------------------------------------*/
    var pm25Group = L.layerGroup([pollutionOverlay, geojsonLayer]);
    var no2Group = L.layerGroup([pollutionOverlay2, geojsonLayer2]);

    // ğŸ”¥ é è¨­é–‹å•Ÿ PM2.5
    pm25Group.addTo(map);


    /*----------------------------- ç›£æ¸¬ç«™é»ä½åœ–å±¤ ----------------------------------*/
    function getDistance(c1, c2) {
        var dx = c1[0] - c2[0];
        var dy = c1[1] - c2[1];
        return Math.sqrt(dx * dx + dy * dy);
    }
    function getClosestValue(stationCoords, geojsonData) {
        var minDistance = Infinity;
        var closestValue = "N/A";

        geojsonData.features.forEach(function(feature) {
            var coords = feature.geometry.coordinates;
            var dist = getDistance(stationCoords, coords);
            if (dist < minDistance) {
                minDistance = dist;
                closestValue = feature.properties.value;
            }
        });
        return (closestValue !== undefined) ? closestValue.toFixed(2) : "N/A";
    }

    var stationIcon = L.icon({
        iconUrl: 'weather-station.png',
        iconSize: [32, 32],
        iconAnchor: [16, 32],
        popupAnchor: [0, -32]
    });

    var stationLayer = L.geoJSON(stationData, {
        pointToLayer: function (feature, latlng) {
            return L.marker(latlng, { icon: stationIcon });
        },
        onEachFeature: function (feature, layer) {
            var stationCoords = feature.geometry.coordinates;
            var lon = stationCoords[0].toFixed(4);
            var lat = stationCoords[1].toFixed(4);

            layer.on('mouseover', function () { 
                var isPm25Visible = map.hasLayer(pm25Group);
                var isNo2Visible = map.hasLayer(no2Group);

                var pmSection = "";
                if (isPm25Visible) {
                    var pmValue = getClosestValue(stationCoords, pollutionData);
                    pmSection = `
                        <div style="margin-top: 5px; padding: 8px; background: #fdf2f2; border-radius: 4px; border-left: 4px solid #d73027;">
                            <b style="color: #d73027;">PM2.5 æ¿ƒåº¦æ•¸å€¼ï¼š</b><br>
                            <span style="color: #d73027; font-size: 20px; font-weight: bold;">${pmValue}</span> 
                            <small>Âµg/mÂ³</small>
                        </div>`;
                }

                var no2Section = "";
                if (isNo2Visible) {
                    var no2Value = getClosestValue(stationCoords, pollutionNO2Data); 
                    no2Section = `
                        <div style="margin-top: 5px; padding: 8px; background: #eef7ff; border-radius: 4px; border-left: 4px solid #3498db;">
                            <b style="color: #3498db;">NO2 æ¿ƒåº¦æ•¸å€¼ï¼š</b><br>
                            <span style="color: #3498db; font-size: 20px; font-weight: bold;">${no2Value}</span> 
                            <small>ppb</small>
                        </div>`;
                }

                var finalContent = `
                    <div style="font-family: 'Microsoft JhengHei'; min-width: 180px;">
                        <b style="color: #2980b9; font-size: 15px;">ğŸ“ ç›£æ¸¬ç«™è³‡è¨Š</b><br>
                        <hr style="margin: 5px 0; border: 0.5px solid #eee;">
                        <b>æ¸¬ç«™åï¼š</b>${feature.properties.sitename || 'æœªçŸ¥'}<br>
                        <b>æ¸¬ç«™é¡å‹ï¼š</b>${feature.properties.sitetype || 'ç›£æ¸¬ç«™'}<br>
                        ${pmSection}
                        ${no2Section}
                        <hr style="margin: 5px 0; border: 0.5px solid #eee;">
                        <div style="font-size: 11px; color: #777;">åæ¨™ï¼š${lon} , ${lat}</div>
                    </div>`;

                this.bindPopup(finalContent, { closeButton: false, offset: L.point(0, -5) }).openPopup();
            });
            
            layer.on('mouseout', function () { this.closePopup(); });
        }
    }).addTo(map); // ğŸ”¥ é è¨­é–‹å•Ÿç©ºå“ç›£æ¸¬ç«™


    /*--------------------------å°ä¸­é„‰é®å€åœ–å±¤------------------------------*/
    var townLayer = L.geoJSON(taichungBounds, {
        interactive: false,
        style: function(feature) {
            return {
                color: '#666666',      
                weight: 1.5,           
                dashArray: '5, 5',     
                fillColor: 'transparent', 
                fillOpacity: 0
            };
        },
        onEachFeature: function (feature, layer) {
            layer.bindTooltip(feature.properties.TOWNNAME, {
                permanent: true,      
                direction: 'center',  
                className: 'district-label' 
            }).openTooltip();
        }
    }).addTo(map); // ğŸ”¥ é è¨­é–‹å•Ÿè¡Œæ”¿å€é‚Šç•Œ

    /*-----------------------------å°ä¸­é“è·¯---------------------------------*/
    var roadLayer = L.geoJSON(taichungRoad, {
        interactive: false, 
        style: function(feature) {
            return {
                color: "#ffffff",   
                weight: 1,        
                opacity: 0.8        
            };
        }
    });

    /*----------------------------------------------------------------åŠ å…¥æ¯”ä¾‹å°ºã€åœ–ä¾‹(åŠŸèƒ½)---------------------------------------------------------------------------*/

    // 7.åŠ å…¥æ¯”ä¾‹å°º
    L.control.scale({
        metric: true,       
        imperial: false,    
        position: 'bottomleft' 
    }).addTo(map);


    /*----------------------------------------------------------------*/
    /* 1. å®šç¾©æ¨™è¨˜é»èˆ‡åœ–ä¾‹ç‰©ä»¶ */
    /*----------------------------------------------------------------*/

    // å°é›»æ¨™è¨˜é»
    var marker = L.marker([24.22, 120.485]).bindPopup("<b>å°ä¸­ç«åŠ›ç™¼é›»å» </b>");

    // PM2.5 åœ–ä¾‹
    var legendPM25 = L.control({position: 'bottomright'});
    legendPM25.onAdd = function (map) {
        var div = L.DomUtil.create('div', 'info legend'),
            grades = [10, 20, 30, 40, 50],
            labels = ['#fee5d9', '#fcae91', '#fb6a4a', '#de2d26', '#a50f15'];
        div.innerHTML = '<h4>PM2.5 æ¿ƒåº¦ (Âµg/mÂ³)</h4>';
        for (var i = 0; i < grades.length; i++) {
            div.innerHTML += '<i style="background:' + labels[i] + '"></i> ' +
                grades[i] + (grades[i + 1] ? '&ndash;' + grades[i + 1] + '<br>' : '+');
        }
        return div;
    };

    // NO2 åœ–ä¾‹
    var legendNO2 = L.control({position: 'bottomright'});
    legendNO2.onAdd = function (map) {
        var div = L.DomUtil.create('div', 'info legend'),
            grades = [0, 10, 20, 30, 40],
            labels = ['#eef7ff', '#3498db', '#2980b9', '#2471a3', '#1a5276']; 
        div.innerHTML = '<h4>NO2 æ¿ƒåº¦ (ppb)</h4>';
        for (var i = 0; i < grades.length; i++) {
            div.innerHTML += '<i style="background:' + labels[i] + '"></i> ' +
                grades[i] + (grades[i + 1] ? '&ndash;' + grades[i + 1] + '<br>' : '+');
        }
        return div;
    };

    /*----------------------------------------------------------------*/
    /* 2. æ ¸å¿ƒæ§åˆ¶é‚è¼¯ï¼šç›£è½åœ–å±¤åˆ‡æ› */
    /*----------------------------------------------------------------*/

    map.on('overlayadd', function(eventLayer) {
        if (eventLayer.name === 'PM2.5 æ¿ƒåº¦è³‡è¨Š') {
            legendPM25.addTo(map);
            marker.addTo(map);
            if (searchControl) searchControl.addTo(map); 
            if (map.hasLayer(no2Group)) map.removeControl(legendNO2);
        }
        if (eventLayer.name === 'NO2 æ¿ƒåº¦è³‡è¨Š') {
            legendNO2.addTo(map);
            marker.addTo(map);
            if (searchControl) searchControl.addTo(map); 
            if (map.hasLayer(pm25Group)) map.removeControl(legendPM25);
        }
    });

    map.on('overlayremove', function(eventLayer) {
        if (eventLayer.name === 'PM2.5 æ¿ƒåº¦è³‡è¨Š') {
            map.removeControl(legendPM25);
            if (map.hasLayer(no2Group)) {
                legendNO2.addTo(map);
            } else {
                map.removeLayer(marker);
                map.removeControl(searchControl);
            }
        }
        if (eventLayer.name === 'NO2 æ¿ƒåº¦è³‡è¨Š') {
            map.removeControl(legendNO2);
            if (map.hasLayer(pm25Group)) {
                legendPM25.addTo(map);
            } else {
                map.removeLayer(marker);
                map.removeControl(searchControl);
            }
        }
    });

    /*----------------------------------------------------------------*/
    /* 3. åˆå§‹ç‹€æ…‹æª¢æŸ¥ (é é¢å‰›è¼‰å…¥æ™‚åŸ·è¡Œ) */
    /*----------------------------------------------------------------*/
    if (map.hasLayer(pm25Group)) {
        legendPM25.addTo(map);
        marker.addTo(map);
    } else if (map.hasLayer(no2Group)) {
        legendNO2.addTo(map);
        marker.addTo(map);
    }


/*------------------------------------------------------------------------åœ°åœ–ä¸­ç¶“ç·¯åº¦é¡¯ç¤ºæ¡†(åœ°åœ–ä¸­ä¸‹æ–¹)-------------------------------------------------------------------------*/

    // 8. å»ºç«‹ä¸€å€‹è‡ªå®šç¾©æ§åˆ¶é …ï¼Œå°ˆé–€ç”¨ä¾†é¡¯ç¤ºåº§æ¨™
        var coordsControl = L.control({position: 'bottomleft'});

        coordsControl.onAdd = function (map) {
            var div = L.DomUtil.create('div', 'coords-wrapper');
            var center = map.getCenter();
            var lat = center.lat.toFixed(4);
            var lng = center.lng.toFixed(4);

            div.innerHTML = `
                <div id="coords" class="coordinate-display">
                    ğŸ¹ è§€æ¸¬ä¸­ | ğŸ“ ç¶“åº¦: ${lng} | ç·¯åº¦: ${lat}
                </div>
            `;
            return div;
        };

        coordsControl.addTo(map);

        map.on('mousemove', function(e) {
            var lat = e.latlng.lat.toFixed(4);
            var lng = e.latlng.lng.toFixed(4);
            var target = document.getElementById('coords');
            if (target) {
                target.innerHTML = `ğŸ¹ è§€æ¸¬ä¸­ | ğŸ“ ç¶“åº¦: ${lng} | ç·¯åº¦: ${lat}`;
            }
        });


    /*----------------------------------------------------------------åœ°åœ–å³ä¸Šè§’åœ–å±¤é¸å–®------------------------------------------------------------------------*/

    var baseMaps = {
        "æ¨™æº–è¡—é“åœ°åœ–": osm,
        "è¡›æ˜Ÿå½±åƒåœ–": satellite
    };
    

    // 2. ç–ŠåŠ åœ–å±¤æ”¹ç‚ºã€Œå·¢ç‹€çµæ§‹ã€
    // æ ¼å¼ï¼š "çµ„å": { "åœ–å±¤é¡¯ç¤ºåç¨±": åœ–å±¤è®Šæ•¸ }
    var groupedOverlays = {
        "ğŸ“ åŸºç¤åœ–å±¤": {
            "ç¸£å¸‚é‚Šç•Œ": boundaryLayer,
            "è¡Œæ”¿å€é‚Šç•Œ": townLayer,
            "ç©ºå“ç›£æ¸¬ç«™": stationLayer
        },
        "â˜ï¸ ç©ºæ±¡æ¿ƒåº¦æ¨ä¼°": {
            "PM2.5 æ¿ƒåº¦è³‡è¨Š": pm25Group,
            "NO2 æ¿ƒåº¦è³‡è¨Š": no2Group
        },
        "ğŸ›£ï¸ åœŸåœ°åˆ©ç”¨": {
            "ä¸»è¦é“è·¯": roadLayer
        }
    };

    // 3. ä½¿ç”¨å¤–æ›çš„æŒ‡ä»¤ L.control.groupedLayers
    // æ³¨æ„ï¼šé€™è£¡çš„åƒæ•¸æ˜¯ groupedOverlaysï¼Œä¸æ˜¯ä¹‹å‰çš„ allOverlays
    var layerControl = L.control.groupedLayers(baseMaps, groupedOverlays, {
        collapsed: false,       // é è¨­å±•é–‹é¸å–®
        groupCheckboxes: false,   // ğŸŒŸ é¡å¤–åŠŸèƒ½ï¼šçµ„åæ—é‚Šæœƒå‡ºç¾ä¸€å€‹æ–¹å¡Šï¼Œå¯ä»¥ã€Œä¸€éµå…¨é¸/å…¨å–æ¶ˆã€è©²çµ„åœ–å±¤
        exclusiveGroups: ["â˜ï¸ ç©ºæ±¡æ¿ƒåº¦æ¨ä¼°"] // ğŸŒŸ é€™çµ„è£¡é¢çš„ PM2.5 å’Œ NO2 æœƒè®Šæˆåœ“åœˆæŒ‰éˆ•ï¼Œåªèƒ½é¸ä¸€å€‹
    }).addTo(map);


    // --- ä¿®æ­£å¾Œçš„é»æ“Šæ”¶åˆé‚è¼¯ ---
    function setupLayerAccordion() {
        // 1. æ‰¾åˆ°æ‰€æœ‰çš„ç¾¤çµ„æ¨™é¡Œ (span)
        var groupTitles = document.querySelectorAll('.leaflet-control-layers-group-name');
        
        if (groupTitles.length === 0) {
            // å¦‚æœé‚„æ²’ç”Ÿæˆï¼Œ0.2ç§’å¾Œå†è©¦ä¸€æ¬¡ (éè¿´)
            setTimeout(setupLayerAccordion, 200);
            return;
        }

        groupTitles.forEach(function(title) {
            // ç¢ºä¿ä¸é‡è¤‡ç¶å®š
            if (title.getAttribute('data-bound')) return;
            title.setAttribute('data-bound', 'true');

            title.onclick = function(e) {
                // é˜»æ­¢ Leaflet åŸç”Ÿçš„äº‹ä»¶å¹²æ“¾
                L.DomEvent.stopPropagation(e);
                
                // æ‰¾åˆ°æœ€å¤–å±¤çš„ç¾¤çµ„å®¹å™¨
                var container = this.closest('.leaflet-control-layers-group');
                if (container) {
                    container.classList.toggle('is-open');
                }
            };
        });
    }

    // åŸ·è¡Œç¶å®š
    setupLayerAccordion();


    /*----------------------------------æ›´æ”¹ç¸®æ”¾éµä½ç½®-------------------------------------*/
    map.zoomControl.remove();
    L.control.zoom({
        position: 'bottomleft' 
    }).addTo(map);


    /*--------------------------------------------------------------------åæ¨™æ¿ƒåº¦æœå°‹---------------------------------------------------------------------------------*/
    
    var searchControl = L.control({position: 'topleft'});

    searchControl.onAdd = function (map) {
        var div = L.DomUtil.create('div', 'search-panel-container');
        div.innerHTML = `
            <div id="search-box" style="
                background: white; 
                padding: 15px; 
                border-radius: 8px; 
                box-shadow: 0 2px 15px rgba(0,0,0,0.2);
                border: 2px solid #003049;
                min-width: 300px;
            ">
                <h2 style="margin: 0 0 12px 0; font-size: 18px; color: #2c3e50; font-weight: bold;">ğŸ” æƒ³æŸ¥è©¢å“ªè£¡çš„æ¿ƒåº¦æ•¸å€¼?</h2>
                
                <div style="display: flex; align-items: flex-end; gap: 10px;">
                    
                    <div class="input-group" style="display: flex; flex-direction: column; gap: 4px;">
                        <label style="font-size: 14px; color: #666; font-weight: bold;">ç¶“åº¦ (lon)ï¼š</label>
                        <input type="number" id="lngInput" step="0.0001" value="120.647" 
                            style="width: 100px; padding: 6px; border: 1px solid #ccc; border-radius: 4px;">
                    </div>

                    <div class="input-group" style="display: flex; flex-direction: column; gap: 4px;">
                        <label style="font-size: 14px; color: #666; font-weight: bold;">ç·¯åº¦ (lat)ï¼š</label>
                        <input type="number" id="latInput" step="0.0001" value="24.162" 
                            style="width: 100px; padding: 6px; border: 1px solid #ccc; border-radius: 4px;">
                    </div>
                    
                    
                    <button onclick="queryCoordinate()" style="
                        padding: 7px 15px; 
                        background-color: #3498db; 
                        color: white; 
                        border: none; 
                        border-radius: 4px; 
                        cursor: pointer; 
                        font-weight: bold;
                        height: 33px; 
                    ">æŸ¥è©¢æ•¸å€¼</button>
                </div>
                
                <div id="queryResult" style="margin-top: 12px; font-weight: bold; color: #d73027; font-size: 14px;"></div>
            </div>
        `;
        
        L.DomEvent.disableScrollPropagation(div);
        L.DomEvent.disableClickPropagation(div);
        
        return div;
    };

    // å› ç‚ºç¾åœ¨ PM2.5 é è¨­æ˜¯é–‹å•Ÿçš„ï¼Œæ‰€ä»¥é€™è£¡æœƒåŸ·è¡Œï¼Œè®“æœå°‹æ¡†åœ¨è¼‰å…¥æ™‚å°±é¡¯ç¤º
    if (map.hasLayer(pm25Group)) {
        searchControl.addTo(map);
    }

    var searchMarkerCircle = null;

    // 12. è¼¸å…¥åæ¨™æœå°‹æ¿ƒåº¦å€¼
    function queryCoordinate() {
        var resDiv = document.getElementById('queryResult'); 
        var latInput = document.getElementById('latInput');
        var lngInput = document.getElementById('lngInput');

        var inputLat = parseFloat(latInput.value);
        var inputLng = parseFloat(lngInput.value);

        if (searchMarkerCircle) {
            map.removeLayer(searchMarkerCircle);
        }

        map.flyTo([inputLat, inputLng], 14);
        
        var latMin = 23.755, latMax = 24.71;
        var lngMin = 120.275, lngMax = 121.62;     

        if (inputLat < latMin || inputLat > latMax || inputLng < lngMin || inputLng > lngMax) {
            resDiv.innerHTML = "åæ¨™è¶…å‡ºæ¨ä¼°ç¯„åœ";
            L.popup().setLatLng([inputLat, inputLng]).setContent("<b style='color:red;'>ç¯„åœå¤–</b><br>æ­¤è™•ç„¡æ¨¡å‹æ¨ä¼°æ•¸æ“š").openOn(map);
            return;
        }

        var targetData = null;
        var unit = "";
        var name = "";

        if (map.hasLayer(pm25Group)) {
            targetData = pollutionData;
            unit = "Âµg/mÂ³";
            name = "PM2.5";
        } else if (map.hasLayer(no2Group)) {
            targetData = pollutionNO2Data;
            unit = "ppb";
            name = "NO2";
        } else {
             resDiv.innerHTML = "è«‹å…ˆé–‹å•Ÿä»»ä¸€æ¿ƒåº¦åœ–å±¤";
             return;
        }


        var minDistance = Infinity;
        var closestFeature = null;

        targetData.features.forEach(function(feature) {
            var coords = feature.geometry.coordinates; 
            var dist = Math.sqrt(
                Math.pow(inputLat - coords[1], 2) + 
                Math.pow(inputLng - coords[0], 2)
            );

            if (dist < minDistance) {
                minDistance = dist;
                closestFeature = feature;
            }
        });

        if (minDistance > 0.005) { 
            resDiv.innerHTML = "æœå°‹ä½ç½®è¼ƒååƒ»ï¼Œç„¡æœ‰æ•ˆæ¨ä¼°æ•¸æ“š";
            L.popup().setLatLng([inputLat, inputLng]).setContent("<b style='color:orange;'>ç„¡æ•¸æ“š</b><br>æœå°‹é»å‘¨é‚Šç„¡ç›£æ¸¬ç¶²æ ¼").openOn(map);
            return;
        }

        if (closestFeature) {
            var rawValue = closestFeature.properties.value;
            var value = rawValue.toFixed(2);
            
            // æœå°‹é‚è¼¯ï¼šåªåœ¨ PM2.5 æ™‚åˆ¤æ–·æ¨™æº–ï¼ŒNO2 ä¸åšåˆ¤æ–·
            var statusHtml = ""; 

            if (name === "PM2.5") {
                if (rawValue > 30) {
                    statusHtml = `<br><b style="color: red; font-size: 14px;">âŒè¶…éæ¯æ—¥å¹³å‡æ¨™æº–</b>`;
                } else {
                    statusHtml = `<br><b style="color: green; font-size: 14px;">âœ…ç¬¦åˆæ¯æ—¥å¹³å‡æ¨™æº–</b>`;
                }
            }
            // å¦‚æœæ˜¯ NO2ï¼ŒstatusHtml å°±ä¿æŒç©ºå­—ä¸²

            var resDiv = document.getElementById('queryResult');
            resDiv.innerHTML = "â¡ï¸ é€™å€‹ä½ç½®çš„ " + name + " æ¿ƒåº¦ç‚ºï¼š " + value + " " + unit;

            searchMarkerCircle = L.circle([inputLat, inputLng], {
                radius: 100,
                color: '#d73027',
                weight: 2,
                fillColor: '#f1c40f',
                fillOpacity: 1,
                dashArray: '5, 5',
                interactive: false
            }).addTo(map);
                
            map.setView([inputLat, inputLng], 14);
            
            L.popup()
                .setLatLng([inputLat, inputLng])
                .setContent(`
                    <div style="font-family: 'Microsoft JhengHei';">
                        <b>ğŸ“æŸ¥è©¢åæ¨™ï¼š</b><br>${inputLat}, ${inputLng}<br>
                        <hr style="margin: 5px 0;">
                        <b>${name} é ä¼°æ¿ƒåº¦ï¼š</b>${value} ${unit}
                        ${statusHtml} 
                    </div>
                `)
                .openOn(map);
        }
    }

    /*----------------------------------------------------------------------------------------------------------------------------------------*/

    </script>
    
    
</body>

</html>





